generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Provider {
  id                         String                       @id @default(uuid())
  businessName               String
  ownerName                  String
  email                      String                       @unique
  phone                      String
  serviceTypes               String[]                     @default([])
  serviceAreas               String[]                     @default([])
  yearsInBusiness            Int                          @default(0)
  // Onboarding fields
  primaryCategory            String?                      @map("primary_category")
  insuranceProvider          String?                      @map("insurance_provider")
  serviceRadiusType          String?                      @map("service_radius_type") // "10", "25", "50", "100", "statewide"
  businessZipCode            String?                      @map("business_zip_code")
  travelDistance             String?                      @map("travel_distance") // "10", "25", "50", "city", "statewide"
  status                     String                       @default("active")
  leadCapacity               Int                          @default(10)
  currentLeadCount           Int                          @default(0)
  rating                     Float                        @default(4.5)
  totalLeadsSent             Int                          @default(0)
  leadsAccepted              Int                          @default(0)
  leadsConverted             Int                          @default(0)
  totalRevenue               Float                        @default(0)
  commissionRate             Float                        @default(0.15)
  averageJobValue            Float                        @default(5000)
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  lastActivityAt             DateTime                     @default(now())
  workingHours               Json?
  timeZone                   String                       @default("America/Chicago")
  bufferTime                 Int                          @default(30)
  advanceBooking             Int                          @default(14)
  availabilityNotes          String?
  customServices             Json[]                       @default([])
  avatar                     String?
  profilePhotoUrl            String?                      @map("profile_photo_url")
  profilePhotoBlobPath       String?                      @map("profile_photo_blob_path")
  bio                        String?
  certifications             String[]                     @default([])
  onboardingCompleted        Boolean                      @default(false)
  businessAddress            String?
  city                       String?
  state                      String?
  zipCode                    String?                      @map("zip_code")
  // Office location for route optimization
  officeLatitude             Float?                       @map("office_latitude")
  officeLongitude            Float?                       @map("office_longitude")
  taxId                      String?                      @map("tax_id")
  businessEntity             String?                      @map("business_entity")
  serviceRadius              Int                          @default(25)
  website                    String?
  businessHours              String?
  servicePricing             Json?
  minimumJobValue            Float?
  depositRequired            Boolean                      @default(false)
  depositPercentage          Int                          @default(25)
  paymentTerms               String                       @default("net_30")
  acceptedPaymentMethods     String[]                     @default(["cash", "check", "credit_card"])
  autoInvoiceOnCompletion    Boolean                      @default(true)
  customerNoteTemplates      String[]                     @default([]) @map("customer_note_templates")
  // Worker Permission Settings
  workersCanCreateJobs       Boolean                      @default(false) @map("workers_can_create_jobs")
  workerJobsNeedApproval     Boolean                      @default(true) @map("worker_jobs_need_approval")
  workersCanEditSkills       Boolean                      @default(false) @map("workers_can_edit_skills")
  workersCanEditAvailability Boolean                      @default(true) @map("workers_can_edit_availability")
  workersCanViewTeamSchedule Boolean                      @default(false) @map("workers_can_view_team_schedule")
  requireCompletionPhotos    Boolean                      @default(false) @map("require_completion_photos")
  ownerId                    String?                      @map("owner_id")
  activeSeats                Int                          @default(1) @map("active_seats")
  stripeCustomerId           String?                      @map("stripe_customer_id")
  stripeSubscriptionId       String?                      @map("stripe_subscription_id")
  subscriptionStatus         String?                      @map("subscription_status")
  planType                   String?                      @map("plan_type")
  pricePerSeat               Int?                         @map("price_per_seat")
  maxSeats                   Int                          @default(50) @map("max_seats")
  currentPeriodEnd           DateTime?                    @map("current_period_end")
  blockedTimes               BlockedTime[]                @relation("ProviderBlockedTimes")
  customer_subscriptions     customer_subscriptions[]
  customers                  Customer[]                   @relation("ProviderCustomers")
  invoices                   Invoice[]                    @relation("ProviderInvoices")
  jobs                       Job[]                        @relation("ProviderJobs")
  promotions                 promotions[]
  provider_customer_messages provider_customer_messages[]
  reviews                    reviews[]
  users                      ProviderUser[]               @relation("ProviderUsers")
  crews                      Crew[]                       @relation("ProviderCrews")
  skills                     Skill[]                      @relation("ProviderSkills")
  notifications              Notification[]               @relation("ProviderNotifications")
  workLogs                   WorkLog[]                    @relation("ProviderWorkLogs")
  statusLogs                 UserStatusLog[]              @relation("ProviderStatusLogs")
  teamMessages               team_messages[]
  serviceChecklists          ServiceChecklist[]           @relation("ProviderChecklists")
}

model Notification {
  id          String   @id @default(cuid())
  providerId  String   @map("provider_id")
  provider    Provider @relation("ProviderNotifications", fields: [providerId], references: [id], onDelete: Cascade)
  userId      String?  @map("user_id") // specific user to notify, null = all owners/office
  type        String   // 'time_off_request', 'job_completed', 'new_customer', 'payment_received', 'worker_clocked_in', 'job_created_by_worker'
  title       String
  message     String
  link        String?  // where to go when clicked, e.g., "/provider/team?tab=time-off"
  data        Json?
  read        Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([providerId])
  @@index([userId])
  @@index([read])
  @@map("notifications")
}

model ProviderUser {
  id                String              @id @default(cuid())
  providerId        String              @map("provider_id")
  email             String              @unique
  passwordHash      String              @map("password_hash")
  firstName         String              @map("first_name")
  lastName          String              @map("last_name")
  phone             String?
  role              String              // "owner", "office", "field"
  status            String              @default("active") // "active", "inactive", "on_leave"
  skills            String[]            @default([]) // DEPRECATED: Use workerSkills relation instead
  color             String?             // Hex color for calendar display
  hourlyRate        Float?              @map("hourly_rate")
  payType           String?             @map("pay_type") // "hourly" or "commission"
  commissionRate    Float?              @map("commission_rate") // percentage like 50.0 for 50%
  workingHours      Json?               @map("working_hours") // {"monday": {"start": "08:00", "end": "17:00"}}
  profilePhotoUrl   String?             @map("profile_photo_url")
  profilePhotoBlobPath String?          @map("profile_photo_blob_path")
  // Smart Scheduler fields
  homeAddress       String?             @map("home_address") // For travel distance calculations
  homeLatitude      Float?              @map("home_latitude")
  homeLongitude     Float?              @map("home_longitude")
  // Real-time location tracking (when clocked in)
  currentLatitude         Float?        @map("current_latitude")
  currentLongitude        Float?        @map("current_longitude")
  currentLocationAccuracy Float?        @map("current_location_accuracy") // meters
  currentLocationHeading  Float?        @map("current_location_heading") // degrees
  currentLocationSpeed    Float?        @map("current_location_speed") // m/s
  lastLocationUpdate      DateTime?     @map("last_location_update")
  // Worker permissions
  canCreateJobs     Boolean             @default(false) @map("can_create_jobs")
  jobsNeedApproval  Boolean             @default(true) @map("jobs_need_approval")
  // Login tracking for billing fraud prevention
  lastLoginAt       DateTime?           @map("last_login_at")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  provider          Provider            @relation("ProviderUsers", fields: [providerId], references: [id], onDelete: Cascade)
  workerSkills      ProviderUserSkill[] @relation("UserSkills")
  workLogs          WorkLog[]           @relation("UserWorkLogs")
  statusLogs        UserStatusLog[]     @relation("UserStatusLogs")
  sentTeamMessages  team_messages[]     @relation("SentTeamMessages")

  @@index([providerId])
  @@index([email])
  @@index([role])
  @@map("provider_users")
}

// Audit log for user status changes - prevents billing fraud
model UserStatusLog {
  id         String       @id @default(cuid())
  userId     String       @map("user_id")
  providerId String       @map("provider_id")
  oldStatus  String       @map("old_status")
  newStatus  String       @map("new_status")
  changedBy  String       @map("changed_by") // userId of who made the change
  changedAt  DateTime     @default(now()) @map("changed_at")
  user       ProviderUser @relation("UserStatusLogs", fields: [userId], references: [id], onDelete: Cascade)
  provider   Provider     @relation("ProviderStatusLogs", fields: [providerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([providerId])
  @@index([changedAt])
  @@map("user_status_logs")
}

model Crew {
  id           String          @id @default(cuid())
  providerId   String          @map("provider_id")
  name         String
  userIds      String[]        @default([]) @map("user_ids")
  leaderId     String?         @map("leader_id")
  color        String          @default("#10b981")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  provider     Provider        @relation("ProviderCrews", fields: [providerId], references: [id], onDelete: Cascade)
  jobs         Job[]           @relation("AssignedCrewJobs")
  teamMessages team_messages[] @relation("CrewMessages")

  @@index([providerId])
  @@map("crews")
}

model Customer {
  id                                                  String                       @id @default(cuid())
  providerId                                          String                       @map("provider_id")
  name                                                String
  email                                               String?
  phone                                               String
  address                                             String
  source                                              String                       @default("own")
  tags                                                String[]                     @default([])
  notes                                               String?
  streetViewUrl                                       String?                      @map("street_view_url") // Cached Street View URL
  // Smart Scheduler fields
  latitude                                            Float? // For distance calculations
  longitude                                           Float? // For distance calculations
  zone                                                String? // ZIP code or service area
  createdAt                                           DateTime                     @default(now()) @map("created_at")
  updatedAt                                           DateTime                     @updatedAt @map("updated_at")
  customer_credits                                    customer_credits[]
  customer_notifications                              customer_notifications[]
  customer_payment_methods                            customer_payment_methods[]
  customer_promotions                                 customer_promotions[]
  customer_subscriptions                              customer_subscriptions[]
  provider                                            Provider                     @relation("ProviderCustomers", fields: [providerId], references: [id], onDelete: Cascade)
  invoices                                            Invoice[]                    @relation("CustomerInvoices")
  jobs                                                Job[]                        @relation("CustomerJobs")
  loyalty_points                                      loyalty_points?
  provider_customer_messages                          provider_customer_messages[]
  referrals_referrals_referred_customer_idTocustomers referrals[]            @relation("referrals_referred_customer_idTocustomers")
  referrals_referrals_referrer_idTocustomers          referrals[]            @relation("referrals_referrer_idTocustomers")
  reviews                                             reviews[]
  review_helpfulness                                  review_helpfulness[]

  @@index([providerId])
  @@index([phone])
  @@index([zone])
  @@map("customers")
}

model Job {
  id                    String                 @id @default(cuid())
  providerId            String                 @map("provider_id")
  customerId            String                 @map("customer_id")
  serviceType           String                 @map("service_type")
  address               String
  startTime             DateTime               @map("start_time")
  endTime               DateTime               @map("end_time")
  status                String                 @default("scheduled")
  source                String                 @default("own")
  estimatedValue        Float?                 @map("estimated_value")
  actualValue           Float?                 @map("actual_value")
  jobInstructions       String?                @map("job_instructions") // Office â†’ worker instructions (renamed from internalNotes)
  customerNotes         String?                @map("customer_notes")   // Customer leaves, both see
  fieldNotes            String?                @map("field_notes")      // Worker writes, visible in history
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  booking_source        String?
  bundle_id             String?
  upsells               Json?
  last_reminder_date    DateTime?
  next_due_date         DateTime?
  recommended_frequency Int?
  reminder_sent         Boolean                @default(false)
  isRecurring           Boolean                @default(false) @map("is_recurring")
  recurringFrequency    String?                @map("recurring_frequency")
  recurringEndDate      DateTime?              @map("recurring_end_date")
  parentRecurringJobId  String?                @map("parent_recurring_job_id")
  assignedUserIds       String[]               @default([]) @map("assigned_user_ids")
  assignedCrewId        String?                @map("assigned_crew_id")
  dispatchedAt          DateTime?              @map("dispatched_at")
  onTheWayAt            DateTime?              @map("on_the_way_at")
  arrivedAt             DateTime?              @map("arrived_at")
  completedByUserId     String?                @map("completed_by_user_id")
  completedAt           DateTime?              @map("completed_at")
  // Smart Scheduler fields
  crewSizeRequired      Int?                   @map("crew_size_required") // Number of workers needed
  jobPriority           Int                    @default(5) @map("job_priority") // 1-10, higher = more important
  jobCategory           String?                @map("job_category") // "emergency", "urgent", "recurring", "maintenance", "first_visit"
  serviceWindowMins     Int?                   @map("service_window_mins") // Acceptable delay in minutes
  requiredEquipment     String[]               @default([]) @map("required_equipment") // Equipment IDs needed
  latitude              Float? // For distance calculations
  longitude             Float? // For distance calculations
  zone                  String? // ZIP code or service area
  durationMinutes       Int?                   @map("duration_minutes") // Estimated duration in minutes
  actualDurationMinutes Int?                   @map("actual_duration_minutes") // Actual time spent (minutes)
  // Dispatch/Route fields
  appointmentType       String                 @default("anytime") @map("appointment_type") // "fixed", "anytime", "window"
  routeOrder            Int?                   @map("route_order") // Position in worker's route for the day
  estimatedArrival      DateTime?              @map("estimated_arrival") // Calculated ETA
  // Payment fields
  paymentMethod         String?                @map("payment_method") // cash, check, card
  paymentStatus         String?                @map("payment_status") // paid, pending
  tipAmount             Float?                 @map("tip_amount")
  stripeSessionId       String?                @map("stripe_session_id")
  stripePaymentUrl      String?                @map("stripe_payment_url")
  // Cancellation fields
  cancellationReason    String?                @map("cancellation_reason")
  cancelledAt           DateTime?              @map("cancelled_at")
  cancelledBy           String?                @map("cancelled_by")
  // Skill requirements (copied from ServiceTypeConfig at creation)
  requiredSkillIds      String[]               @default([]) @map("required_skill_ids")
  preferredSkillIds     String[]               @default([]) @map("preferred_skill_ids")
  // Multi-worker support
  requiredWorkerCount   Int                    @default(1) @map("required_worker_count")
  // Buffer time between jobs (minutes)
  bufferMinutes         Int                    @default(15) @map("buffer_minutes")
  // Audit trail for skill overrides
  allowUnqualified          Boolean            @default(false) @map("allow_unqualified")
  unqualifiedOverrideBy     String?            @map("unqualified_override_by")
  unqualifiedOverrideAt     DateTime?          @map("unqualified_override_at")
  unqualifiedOverrideReason String?            @map("unqualified_override_reason")
  invoices              Invoice?
  photos                JobPhoto[]             @relation("JobPhotos")
  customer              Customer               @relation("CustomerJobs", fields: [customerId], references: [id], onDelete: Cascade)
  provider              Provider               @relation("ProviderJobs", fields: [providerId], references: [id], onDelete: Cascade)
  assignedCrew          Crew?                  @relation("AssignedCrewJobs", fields: [assignedCrewId], references: [id])
  loyalty_transactions  loyalty_transactions[]
  reviews               reviews?
  workLogs              WorkLog[]              @relation("JobWorkLogs")
  completionData        JobCompletionData?     @relation("JobCompletionData")

  @@index([providerId])
  @@index([assignedCrewId])
  @@index([customerId])
  @@index([startTime])
  @@index([assignedUserIds])
  @@index([zone])
  @@index([jobCategory])
  @@map("jobs")
}

model JobPhoto {
  id            String   @id @default(cuid())
  jobId         String   @map("job_id")
  type          String
  url           String
  blobPathname  String   @map("blob_pathname")
  createdAt     DateTime @default(now()) @map("created_at")
  job           Job      @relation("JobPhotos", fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("job_photos")
}

model BlockedTime {
  id                   String    @id @default(uuid())
  providerId           String    @map("provider_id")
  fromDate             DateTime  @map("from_date")
  toDate               DateTime  @map("to_date")
  startTime            String?   @map("start_time")
  endTime              String?   @map("end_time")
  reason               String
  notes                String?
  isRecurring          Boolean   @default(false) @map("is_recurring")
  recurringType        String?   @map("recurring_type")
  recurringDaysOfWeek  Int[]     @default([]) @map("recurring_days_of_week")
  recurringEndsType    String?   @map("recurring_ends_type")
  recurringOccurrences Int?      @map("recurring_occurrences")
  recurringEndsOnDate  DateTime? @map("recurring_ends_on_date")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  provider             Provider  @relation("ProviderBlockedTimes", fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([fromDate])
  @@index([toDate])
  @@map("blocked_times")
}

model Admin {
  id                 String    @id @default(uuid())
  email              String    @unique
  hashedPassword     String    @map("hashed_password")
  name               String
  role               AdminRole @default(sales_rep)
  mustChangePassword Boolean   @default(false) @map("must_change_password")
  lastLoginAt        DateTime? @map("last_login_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@index([email])
  @@map("admins")
}

model Invoice {
  id                  String            @id @default(uuid())
  invoiceNumber       String            @unique @map("invoice_number")
  providerId          String            @map("provider_id")
  customerId          String            @map("customer_id")
  jobId               String?           @unique @map("job_id")
  status              InvoiceStatus     @default(draft)
  invoiceDate         DateTime          @map("invoice_date")
  dueDate             DateTime          @map("due_date")
  paidDate            DateTime?         @map("paid_date")
  subtotal            Decimal           @db.Decimal(10, 2)
  taxRate             Decimal?          @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount           Decimal           @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountType        DiscountType?     @map("discount_type")
  discountValue       Decimal?          @default(0) @map("discount_value") @db.Decimal(10, 2)
  discountAmount      Decimal           @default(0) @map("discount_amount") @db.Decimal(10, 2)
  total               Decimal           @db.Decimal(10, 2)
  amountPaid          Decimal           @default(0) @map("amount_paid") @db.Decimal(10, 2)
  notes               String?
  terms               String?
  paymentInstructions String?           @map("payment_instructions")
  sentAt                DateTime?         @map("sent_at")
  sentTo                String?           @map("sent_to")
  viewedAt              DateTime?         @map("viewed_at")
  stripePaymentIntentId String?           @unique @map("stripe_payment_intent_id")
  lastPaymentError      String?           @map("last_payment_error")
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")
  lineItems             InvoiceLineItem[] @relation("InvoiceLineItems")
  customer            Customer          @relation("CustomerInvoices", fields: [customerId], references: [id], onDelete: Cascade)
  jobs                Job?              @relation(fields: [jobId], references: [id])
  provider            Provider          @relation("ProviderInvoices", fields: [providerId], references: [id], onDelete: Cascade)
  payments            Payment[]         @relation("InvoicePayments")

  @@index([providerId])
  @@index([customerId])
  @@index([status])
  @@index([invoiceDate])
  @@index([dueDate])
  @@index([jobId])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String   @id @default(uuid())
  invoiceId   String   @map("invoice_id")
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  invoice     Invoice  @relation("InvoiceLineItems", fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_line_items")
}

model Payment {
  id            String        @id @default(uuid())
  invoiceId     String        @map("invoice_id")
  amount        Decimal       @db.Decimal(10, 2)
  paymentDate   DateTime      @map("payment_date")
  paymentMethod PaymentMethod @map("payment_method")
  transactionId String?       @map("transaction_id")
  notes         String?
  recordedBy    String?       @map("recorded_by")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  invoice       Invoice       @relation("InvoicePayments", fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([paymentDate])
  @@map("payments")
}

model customer_credits {
  id          String     @id
  customer_id String
  amount      Decimal    @db.Decimal(10, 2)
  source      String
  referral_id String?
  used_amount Decimal    @default(0) @db.Decimal(10, 2)
  expires_at  DateTime?
  created_at  DateTime   @default(now())
  updated_at  DateTime
  customers   Customer   @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  referrals   referrals? @relation(fields: [referral_id], references: [id])

  @@index([customer_id])
  @@index([expires_at])
  @@index([referral_id])
  @@index([source])
}

model customer_notifications {
  id          String   @id
  customer_id String
  type        String
  title       String
  message     String
  action_url  String?
  read        Boolean  @default(false)
  created_at  DateTime @default(now())
  customers   Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([customer_id])
  @@index([read])
}

model customer_payment_methods {
  id                       String   @id
  customer_id              String
  stripe_payment_method_id String   @unique
  card_brand               String
  card_last4               String
  expiry_month             Int
  expiry_year              Int
  is_default               Boolean  @default(false)
  created_at               DateTime @default(now())
  updated_at               DateTime
  customers                Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)

  @@index([customer_id])
  @@index([is_default])
}

model customer_promotions {
  id               String          @id
  customer_id      String
  promo_code       String          @unique
  discount_percent Decimal?        @db.Decimal(5, 2)
  discount_amount  Decimal?        @db.Decimal(10, 2)
  expires_at       DateTime
  status           PromotionStatus @default(active)
  trigger_type     String
  message          String?
  used_at          DateTime?
  created_at       DateTime        @default(now())
  updated_at       DateTime
  customers        Customer        @relation(fields: [customer_id], references: [id], onDelete: Cascade)

  @@index([customer_id])
  @@index([expires_at])
  @@index([promo_code])
  @@index([status])
  @@index([trigger_type])
}

model customer_subscriptions {
  id                     String                @id
  customer_id            String
  service_type           String
  provider_id            String
  frequency              SubscriptionFrequency
  price                  Decimal               @db.Decimal(10, 2)
  discount_percent       Decimal               @default(10) @db.Decimal(5, 2)
  status                 SubscriptionStatus    @default(active)
  next_scheduled_date    DateTime
  start_date             DateTime
  paused_until           DateTime?
  stripe_subscription_id String?
  stripe_customer_id     String?
  created_at             DateTime              @default(now())
  updated_at             DateTime
  customers              Customer              @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  Provider               Provider              @relation(fields: [provider_id], references: [id], onDelete: Cascade)

  @@index([customer_id])
  @@index([next_scheduled_date])
  @@index([provider_id])
  @@index([status])
}

model loyalty_points {
  id                   String                 @id
  customer_id          String                 @unique
  points               Int                    @default(0)
  lifetime_points      Int                    @default(0)
  tier                 String                 @default("bronze")
  tier_updated_at      DateTime               @default(now())
  created_at           DateTime               @default(now())
  updated_at           DateTime
  customers            Customer               @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  loyalty_transactions loyalty_transactions[]

  @@index([customer_id])
  @@index([tier])
}

model loyalty_rewards {
  id           String   @id
  name         String
  description  String
  points_cost  Int
  reward_value Decimal  @db.Decimal(10, 2)
  reward_type  String
  active       Boolean  @default(true)
  image_url    String?
  created_at   DateTime @default(now())
  updated_at   DateTime

  @@index([active])
  @@index([points_cost])
}

model loyalty_transactions {
  id             String         @id
  customer_id    String
  points         Int
  type           String
  source         String
  description    String
  job_id         String?
  created_at     DateTime       @default(now())
  loyalty_points loyalty_points @relation(fields: [customer_id], references: [customer_id], onDelete: Cascade)
  jobs           Job?           @relation(fields: [job_id], references: [id])

  @@index([created_at])
  @@index([customer_id])
  @@index([type])
}

model promotions {
  id             String    @id
  provider_id    String?
  title          String
  description    String
  service_type   String?
  discount_type  String
  discount_value Float
  target_areas   String[]  @default([])
  min_job_value  Float?
  max_uses       Int?
  current_uses   Int       @default(0)
  valid_from     DateTime
  valid_until    DateTime
  is_active      Boolean   @default(true)
  terms          String?
  created_at     DateTime  @default(now())
  updated_at     DateTime
  code           String?   @unique
  is_renoa_promo Boolean   @default(false)
  Provider       Provider? @relation(fields: [provider_id], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([is_active])
  @@index([is_renoa_promo])
  @@index([provider_id])
  @@index([service_type])
  @@index([valid_from])
  @@index([valid_until])
}

model provider_customer_messages {
  id           String   @id
  provider_id  String
  customer_id  String
  content      String
  direction    String
  type         String   @default("sms")
  status       String   @default("sent")
  media_url    String?
  media_type   String?
  created_at   DateTime @default(now())
  updated_at   DateTime
  customers    Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  Provider     Provider @relation(fields: [provider_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([customer_id])
  @@index([provider_id, customer_id])
}

// Team messages - internal communication between team members
model team_messages {
  id                String   @id @default(cuid())
  provider_id       String
  sender_user_id    String   // ProviderUser who sent it
  recipient_user_id String?  // null = team-wide (broadcast to all), or specific user for DM
  crew_id           String?  // For crew group chats
  content           String
  mediaUrl          String?
  mediaType         String?
  thumbnailUrl      String?
  read              Boolean  @default(false)
  read_by           String[] @default([]) // User IDs who have read (for group chats)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  provider Provider     @relation(fields: [provider_id], references: [id], onDelete: Cascade)
  sender   ProviderUser @relation("SentTeamMessages", fields: [sender_user_id], references: [id], onDelete: Cascade)
  crew     Crew?        @relation("CrewMessages", fields: [crew_id], references: [id], onDelete: Cascade)

  @@index([provider_id])
  @@index([sender_user_id])
  @@index([recipient_user_id])
  @@index([crew_id])
  @@index([provider_id, recipient_user_id])
  @@index([provider_id, crew_id])
  @@index([created_at])
}

model referrals {
  id                                                  String             @id
  referrer_id                                         String
  referred_email                                      String
  referred_phone                                      String?
  referred_customer_id                                String?
  status                                              ReferralStatus     @default(pending)
  referral_code                                       String             @unique
  credit_amount                                       Decimal            @default(50) @db.Decimal(10, 2)
  created_at                                          DateTime           @default(now())
  updated_at                                          DateTime
  customer_credits                                    customer_credits[]
  customers_referrals_referred_customer_idTocustomers Customer?          @relation("referrals_referred_customer_idTocustomers", fields: [referred_customer_id], references: [id])
  customers_referrals_referrer_idTocustomers          Customer           @relation("referrals_referrer_idTocustomers", fields: [referrer_id], references: [id], onDelete: Cascade)

  @@index([referral_code])
  @@index([referred_customer_id])
  @@index([referrer_id])
  @@index([status])
}

model reviews {
  id                   String                 @id
  job_id               String                 @unique
  provider_id          String
  customer_id          String
  rating               Int
  quality_rating       Int?
  timeliness_rating    Int?
  communication_rating Int?
  comment              String?
  response             String?
  responded_at         DateTime?
  is_public            Boolean                @default(true)
  helpful_count        Int                    @default(0)
  created_at           DateTime               @default(now())
  updated_at           DateTime
  customers            Customer               @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  jobs                 Job                    @relation(fields: [job_id], references: [id], onDelete: Cascade)
  Provider             Provider               @relation(fields: [provider_id], references: [id], onDelete: Cascade)
  helpfulness          review_helpfulness[]

  @@index([created_at])
  @@index([customer_id])
  @@index([provider_id])
  @@index([rating])
}

model review_helpfulness {
  id          String   @id @default(uuid())
  review_id   String
  customer_id String
  helpful     Boolean
  created_at  DateTime @default(now())

  review   reviews  @relation(fields: [review_id], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)

  @@unique([review_id, customer_id])
  @@index([review_id])
}

model seasonal_campaigns {
  id               String   @id
  season           String
  campaign_name    String
  service_types    Json
  discount_percent Decimal? @db.Decimal(5, 2)
  email_subject    String
  email_body       String
  start_month      Int
  end_month        Int
  active           Boolean  @default(true)
  created_at       DateTime @default(now())
  updated_at       DateTime

  @@index([active])
  @@index([season])
}

model service_bundles {
  id            String   @id
  name          String
  description   String
  service_types Json
  regular_price Decimal  @db.Decimal(10, 2)
  bundle_price  Decimal  @db.Decimal(10, 2)
  savings       Decimal  @db.Decimal(10, 2)
  season        String?
  active        Boolean  @default(true)
  display_order Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime

  @@index([active])
  @@index([display_order])
  @@index([season])
}

model service_recommendations {
  id                  String   @id
  base_service        String
  recommended_service String
  recommended_price   Decimal  @db.Decimal(10, 2)
  conversion_rate     Decimal  @default(0) @db.Decimal(5, 2)
  display_order       Int      @default(0)
  description         String?
  badge               String?
  is_active           Boolean  @default(true)
  created_at          DateTime @default(now())
  updated_at          DateTime

  @@index([base_service])
  @@index([display_order])
  @@index([is_active])
}

model service_upsells {
  id              String   @id
  base_service    String
  upsell_service  String
  upsell_price    Decimal  @db.Decimal(10, 2)
  description     String
  display_order   Int      @default(0)
  conversion_rate Decimal  @default(0) @db.Decimal(5, 4)
  created_at      DateTime @default(now())
  updated_at      DateTime

  @@index([base_service])
  @@index([display_order])
}

// ============================================
// ENUMS - Only used enums kept
// ============================================

enum AdminRole {
  super_admin
  sales_rep
  customer_support
  developer
}

enum InvoiceStatus {
  draft
  sent
  viewed
  paid
  partial
  overdue
  cancelled
}

enum DiscountType {
  percentage
  fixed
}

enum PaymentMethod {
  cash
  check
  credit_card
  bank_transfer
  online
  other
}

enum PromotionStatus {
  active
  used
  expired
}

enum ReferralStatus {
  pending
  signed_up
  completed_job
  credited
}

enum SubscriptionFrequency {
  weekly
  biweekly
  monthly
}

enum SubscriptionStatus {
  active
  paused
  cancelled
}

// Worker Skills System
model Skill {
  id          String                    @id @default(cuid())
  name        String
  category    String?                   // "landscaping", "hardscaping", "equipment", "certification"
  description String?
  providerId  String                    @map("provider_id")
  isCustom    Boolean                   @default(false) @map("is_custom") // Custom skills created by provider
  provider    Provider                  @relation("ProviderSkills", fields: [providerId], references: [id], onDelete: Cascade)
  createdAt   DateTime                  @default(now()) @map("created_at")
  workers     ProviderUserSkill[]       @relation("SkillWorkers")
  services    ServiceSkillRequirement[] @relation("SkillRequirements")
  serviceTypeConfigs ServiceTypeConfig[] @relation("ServiceTypeSkillRequirements")

  @@unique([providerId, name])
  @@index([providerId])
  @@index([category])
  @@map("skills")
}

model ProviderUserSkill {
  id            String       @id @default(cuid())
  userId        String       @map("user_id")
  skillId       String       @map("skill_id")
  level         String       @default("basic") // "basic", "intermediate", "expert"
  certifiedDate DateTime?    @map("certified_date")
  expiresAt     DateTime?    @map("expires_at")
  createdAt     DateTime     @default(now()) @map("created_at")
  user          ProviderUser @relation("UserSkills", fields: [userId], references: [id], onDelete: Cascade)
  skill         Skill        @relation("SkillWorkers", fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@index([userId])
  @@index([skillId])
  @@map("provider_user_skills")
}

model ServiceSkillRequirement {
  id          String  @id @default(cuid())
  serviceType String  @map("service_type")
  skillId     String  @map("skill_id")
  required    Boolean @default(true) // true = required, false = preferred
  skill       Skill   @relation("SkillRequirements", fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([serviceType, skillId])
  @@index([serviceType])
  @@index([skillId])
  @@map("service_skill_requirements")
}

// ============================================
// SMART SCHEDULER SYSTEM
// ============================================

// Worker schedules - when they work each day
model WorkerSchedule {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  dayOfWeek  Int      @map("day_of_week") // 0=Sunday, 6=Saturday
  startTime  String   @map("start_time") // "08:00"
  endTime    String   @map("end_time") // "17:00"
  isAvailable Boolean @default(true) @map("is_available")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@unique([userId, dayOfWeek])
  @@index([userId])
  @@map("worker_schedules")
}

// Worker time off - vacation, sick days, appointments
model WorkerTimeOff {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  startDate  DateTime @map("start_date")
  endDate    DateTime @map("end_date")
  reason     String? // "vacation", "sick", "appointment", "other"
  notes      String?
  status     String   @default("pending") // "pending", "approved", "denied"
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([startDate, endDate])
  @@index([status])
  @@map("worker_time_off")
}

// Worker metrics - track performance
model WorkerMetrics {
  id                 String   @id @default(cuid())
  userId             String   @unique @map("user_id")
  weeklyHours        Float    @default(0) @map("weekly_hours")
  monthlyHours       Float    @default(0) @map("monthly_hours")
  jobsCompleted      Int      @default(0) @map("jobs_completed")
  avgJobRating       Float?   @map("avg_job_rating")
  customerComplaints Int      @default(0) @map("customer_complaints")
  lateArrivals       Int      @default(0) @map("late_arrivals")
  lastJobDate        DateTime? @map("last_job_date")
  lastUpdated        DateTime @updatedAt @map("last_updated")

  @@index([userId])
  @@map("worker_metrics")
}

// Worker settings - preferences and constraints
model WorkerSettings {
  id                 String   @id @default(cuid())
  userId             String   @unique @map("user_id")
  maxHoursPerDay     Float    @default(8) @map("max_hours_per_day")
  maxHoursPerWeek    Float    @default(40) @map("max_hours_per_week")
  preferredZones     String[] @default([]) @map("preferred_zones") // ZIP codes
  maxTravelDistance  Float?   @map("max_travel_distance") // miles
  canWorkWeekends    Boolean  @default(false) @map("can_work_weekends")
  preferredStartTime String?  @map("preferred_start_time") // "08:00"
  notes              String?
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("worker_settings")
}

// Customer preferences - preferred/blocked workers
model CustomerPreferences {
  id              String   @id @default(cuid())
  customerId      String   @map("customer_id")
  preferredWorkers String[] @default([]) @map("preferred_workers") // User IDs
  blockedWorkers   String[] @default([]) @map("blocked_workers") // User IDs
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([customerId])
  @@index([customerId])
  @@map("customer_preferences")
}

// Schedule proposals - AI-generated assignment suggestions
model ScheduleProposal {
  id          String              @id @default(cuid())
  providerId  String              @map("provider_id")
  scheduleDate DateTime            @map("schedule_date") // Day this proposal is for
  totalJobs   Int                 @default(0) @map("total_jobs")
  assignedJobs Int                @default(0) @map("assigned_jobs")
  unassignedJobs Int              @default(0) @map("unassigned_jobs")
  totalDriveTime Int              @default(0) @map("total_drive_time") // minutes
  averageScore Float?             @map("average_score")
  status      String              @default("pending") // "pending", "approved", "rejected"
  createdBy   String?             @map("created_by")
  reviewedBy  String?             @map("reviewed_by")
  reviewedAt  DateTime?           @map("reviewed_at")
  createdAt   DateTime            @default(now()) @map("created_at")
  assignments ProposedAssignment[] @relation("ProposalAssignments")

  @@index([providerId])
  @@index([scheduleDate])
  @@index([status])
  @@map("schedule_proposals")
}

// Individual job assignment proposals
model ProposedAssignment {
  id          String            @id @default(cuid())
  proposalId  String            @map("proposal_id")
  jobId       String            @map("job_id")
  workerIds   String[]          @default([]) @map("worker_ids")
  suggestedStart DateTime        @map("suggested_start")
  suggestedEnd   DateTime        @map("suggested_end")
  orderInRoute   Int             @map("order_in_route")
  driveTimeFromPrev Int          @default(0) @map("drive_time_from_prev") // minutes
  totalScore  Float // Overall match score 0-100
  scoreBreakdown Json            @map("score_breakdown") // {sla, route, continuity, balance}
  reasoning   String? // Why this assignment was suggested
  warnings    String[] @default([]) // Any issues (skill gaps, conflicts, etc.)
  createdAt   DateTime          @default(now()) @map("created_at")
  proposal    ScheduleProposal  @relation("ProposalAssignments", fields: [proposalId], references: [id], onDelete: Cascade)

  @@index([proposalId])
  @@index([jobId])
  @@map("proposed_assignments")
}

// Service type configuration - skill requirements and weights
model ServiceTypeConfig {
  id                String   @id @default(cuid())
  providerId        String   @map("provider_id")
  serviceType       String   @map("service_type")
  requiredSkills    String[] @default([]) @map("required_skills") // Skill IDs
  preferredSkills   String[] @default([]) @map("preferred_skills") // Skill IDs
  crewSizeMin       Int      @default(1) @map("crew_size_min")
  crewSizeMax       Int      @default(4) @map("crew_size_max")
  estimatedDuration Float    @map("estimated_duration") // hours
  skillWeight       Float    @default(40) @map("skill_weight") // 0-100
  availabilityWeight Float   @default(30) @map("availability_weight")
  workloadWeight    Float    @default(20) @map("workload_weight")
  historyWeight     Float    @default(10) @map("history_weight")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  skills            Skill[]  @relation("ServiceTypeSkillRequirements")

  @@unique([providerId, serviceType])
  @@index([providerId])
  @@index([serviceType])
  @@map("service_type_configs")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

// Service completion checklists per service type
model ServiceChecklist {
  id          String   @id @default(cuid())
  providerId  String   @map("provider_id")
  serviceType String   @map("service_type")
  items       Json     // Array of { id, label, required }
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  provider    Provider @relation("ProviderChecklists", fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, serviceType])
  @@index([providerId])
  @@map("service_checklists")
}

// Job completion data - checklist, signature, photos
model JobCompletionData {
  id                 String    @id @default(cuid())
  jobId              String    @unique @map("job_id")
  checklistCompleted Json?     @map("checklist_completed") // { itemId: boolean }
  signatureUrl       String?   @map("signature_url")
  signedByName       String?   @map("signed_by_name")
  signedAt           DateTime? @map("signed_at")
  completionNotes    String?   @map("completion_notes")
  completionPhotos   String[]  @default([]) @map("completion_photos")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  job                Job       @relation("JobCompletionData", fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("job_completion_data")
}

// Work logs - track time and earnings per job
model WorkLog {
  id                  String       @id @default(cuid())
  jobId               String       @map("job_id")
  userId              String       @map("user_id")
  providerId          String       @map("provider_id")
  clockIn             DateTime     @map("clock_in")
  clockOut            DateTime?    @map("clock_out")
  hoursWorked         Float?       @map("hours_worked")
  earnings            Float?       // Worker's earnings for this job
  isPaid              Boolean      @default(false) @map("is_paid")
  paidAt              DateTime?    @map("paid_at")
  // Payment direction: for cash/check, worker collected money and owes business
  // For card/invoice, business collects and owes worker
  paymentDirection    String?      @map("payment_direction") // 'business_owes_worker' | 'worker_owes_business'
  collectedAmount     Float?       @map("collected_amount") // Total amount worker collected (for cash/check)
  businessOwedAmount  Float?       @map("business_owed_amount") // Amount worker owes business (collected - earnings)
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")
  job                 Job          @relation("JobWorkLogs", fields: [jobId], references: [id], onDelete: Cascade)
  user                ProviderUser @relation("UserWorkLogs", fields: [userId], references: [id], onDelete: Cascade)
  provider            Provider     @relation("ProviderWorkLogs", fields: [providerId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([userId])
  @@index([providerId])
  @@index([isPaid])
  @@index([clockIn])
  @@map("work_logs")
}